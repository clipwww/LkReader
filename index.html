<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
		<!--width=device-width為適應各式裝置螢幕大小 initial-scale=1為初始比例-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
		<!--X-UA-Compatible設置IE兼容模式；有什麼最新的版本IE，就用什麼版本的標準模式。-->
		<meta name="description" content="MetroResume">
		<title>LK READER</title>
		<link href="css/reset.css" rel="stylesheet"> <!--ResetCSS-->	
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/LkReader.css" rel="stylesheet"><!--自己寫的css要最後一個讀取-->
		<script src="js/jquery-2.2.0.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.xdomainajax.js"></script>
		<script>
			$(function(){
				var LkHTML = "";
				var LkMenu = "";
				var LK = "https://www.lightnovel.cn/";

				var LKURL = "https://www.lightnovel.cn/forum-141-1.html";
				$.get(LKURL,getList).done(function(){
					LKURL = "https://www.lightnovel.cn/forum-141-2.html";
					$.get(LKURL,getList).done(function(){
						$("#BOX").append(LkHTML);
						$("#mainMenu ul").append(LkMenu);
						LkHTML="";	
						LkMenu="";						
					})//end get					
				})//end get



				function getList(data){
					console.log(data);
					$(data.responseText).find("[id*=\"normalthread\"] a.xst").each(function(i){
						var comicLink = $(this).attr("href");
						var title = $(this).text();
						title = title.split("][");

			        	LkHTML += "<li>";
			        	LkHTML += "<a href='"+ LK + comicLink +"' targer='_blank' name=\""+title[2]+"\">";
			        	LkHTML += "<span class=\"comicTitle\">" + title[2] + "</span></a>";
			        	LkHTML += "【" + title[3] + "】";
			        	LkHTML += "</li>";

			        	LkMenu += "<li><a href='"+ LK + comicLink +"' targer='_blank' name=\""+title[2]+"\">";
			        	LkMenu += title[2];
			        	LkMenu += "</a></li>";  	

					})//end each
					// $("#BOX").append(LkHTML);
					// $("#mainMenu ul").append(LkMenu);
					// LkHTML="";	
					// LkMenu="";
				}// end function			

				function getComic(){
			    	var link = $(this).attr("href");
			    	$("header p").text( $(this).attr("name") );

					yqlURL = [
				    	"http://query.yahooapis.com/v1/public/yql",
				        "?q=" + encodeURIComponent("select * from html where url='" + link + "'"),
				        "&format=json&callback=?"
				    ].join("");			    					

					$("#BOX").text("");

					$.get(link, function(data){
						var swflink = $(data.responseText).find("param[name=\"movie\"]").attr("value");
						if( swflink ){
							$("#jumpSwf embed").attr("src", swflink);
    						$("#jumpSwf").fadeIn(500);
    						var tempBtn = "<button id=\"openSwf\"></button>";
							$("#BOX").append(tempBtn);
						}
					});//end get

				    $.getJSON(yqlURL,function(data){
				    	
				    	var imgLink = data.query.results.body.div[6].div[3].div[1].div[0].table.tbody.tr[0].td[1].div[1].div[1].div[0].table.tbody.tr.td;

				    	$.each(imgLink.img, function(i, Comic){
				    		imgSrc = Comic.file;
				    		LkHTML += "<img src='"+ imgSrc +"' alt=\"LK\" />";
				    	});//end each

				    	$("#BOX").append(LkHTML);
				    	LkHTML = " ";
				    	
				    });//end getJSON
				    return false;
    			}//end function		


			    $("#BOX").on({
			    	click:getComic
			    },"a")

			    $("#mainMenu").on({
			    	click:getComic
			    },"li a")

			    $("#BOX").on({
			    	click: function(){
			    		var imgSrc = $(this).attr("src");
			    		$("#jumpImage img").attr("src", imgSrc);
			    		$("#jumpImage").fadeIn(500);

			    		$("#BOX img").each(function(i, data){	
			    			if( imgSrc === $(data).attr("src") ){
	    						$("#close").text("第 "+ (i+1) + " 頁。點我關閉。");
	    					}
			    		});
			    	}
			    }, "img");

			     $("#BOX").on({
			    	click: function(){
			    		$("#jumpSwf").fadeIn(500);
			    	}
			    }, "button#openSwf");

			    var imgSrc2;
	    		$("#jumpImage span#next").click(function(){
	    			imgSrc = $("#jumpImage img").attr("src");
	    			$("#BOX img").each(function(i, data){

	    				if( imgSrc === $(data).attr("src") ){
	    					imgSrc2 = $(this).next().attr("src");
	    					$("#close").text("第 "+ (i+2) + " 頁。點我關閉。");

		    				if( imgSrc2 === undefined ){
		    					$("#jumpImage").fadeOut(500);
		    				}
	    				}
	    			});
				    $("#jumpImage img").attr("src", imgSrc2);
	   			});
	   			$("#jumpImage span#prev").click(function(){
	    			imgSrc = $("#jumpImage img").attr("src");
	    			$("#BOX img").each(function(i, data){

	    				if( imgSrc === $(data).attr("src") ){
	    					imgSrc2 = $(this).prev().attr("src");
	    					$("#close").text("第 "+ (i) + " 頁。點我關閉。");

		    				if( imgSrc2 === undefined ){
		    					$("#jumpImage").fadeOut(500);
		    				}
	    				}
	    			});
				    $("#jumpImage img").attr("src", imgSrc2);
	   			});

	   			$("#jumpImage button#close").click(function(){
	   				$("#jumpImage").fadeOut(500);
	   			});

	   			$("#jumpSwf button#closeSwf").click(function(){
	   				$("#jumpSwf").fadeOut(500);
	   			});

	   			$("header span").click(function(){
	   				var open = "glyphicon glyphicon-menu-hamburger";
	   				var close = "glyphicon glyphicon-remove";

	   				if( $(this).attr("class") === open ){
	   					$(this).attr("class",close);
	   					$(".test").css({
	   						"width":"100vw",
	   						"height":"100vh",
	   						"background-color":"rgba(0,0,0,0.5)"
	   					});
		   				$("header").animate({"left":"260px"}, 600);
		   				$("#BOX").animate({"left":"260px"}, 600);
		   				$("#mainMenu").animate({"left":0}, 600);
	   				}else{
	   					$(this).attr("class",open);
		   				$("header").animate({"left":0}, 600);
		   				$("#mainMenu").animate({"left":"-260px"}, 600);	   					
	   				}

	   			});

			});
		</script>
	</head>
	<body>
		<header>
			<span class="glyphicon glyphicon-menu-hamburger"></span>			
			<p>LK輕之國度漫畫發佈區</p>
		</header>

		<div id="mainMenu">
			<a href="index.html" >
				<span class="glyphicon glyphicon-home"></span>
			</a>
			<div>
				<ul>
				</ul>
			</div>
		</div>

		<div id="main" >
			<div id="BOX" class="container">
			</div>
		</div>

		<div id="jumpImage">
			<button id="close" class="btn btn-danger btn-block btn-lg" ></button>
			<span id="prev" class="glyphicon glyphicon-chevron-left"></span>
			<img src=" " alt="jump!"/>
			<span id="next" class="glyphicon glyphicon-chevron-right"></span>
		</div>

		<div id="jumpSwf">
			<button id="closeSwf" class="btn btn-danger btn-block btn-lg" >關閉</button>
			<embed src="" autostart="true"/>
		</div>
	</body>
</html>